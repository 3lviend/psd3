var psd3=psd3||{};psd3.Graph=function(o){this.config=o,this.defaults={width:400,height:400,value:"value",inner:"inner",label:function(o){return o.label},tooltip:function(o){return void 0!==this.config.label?this.config.label(o):o.label},transitionDuration:1e3,donutRadius:0},console.log("before defaults");for(var t in o)console.log(t);for(var t in this.defaults)this.defaults.hasOwnProperty(t)&&(o.hasOwnProperty(t)||(o[t]=this.defaults[t]));console.log("after defaults");for(var t in o)console.log(t)};
var psd3=psd3||{};psd3.Pie=function(t){psd3.Graph.call(this,t),this.zoomStack=new Array;var e="top";void 0!==this.config.heading&&void 0!==this.config.heading.pos&&(e=this.config.heading.pos),"top"==e&&this.setHeading(),this.drawPie(t.data),"bottom"==e&&this.setHeading()},psd3.Pie.prototype=Object.create(psd3.Graph.prototype),psd3.Pie.prototype.constructor=psd3.Pie,psd3.Pie.prototype.setHeading=function(){void 0!==this.config.heading&&d3.select("#"+this.config.containerId).append("div").style("text-align","center").style("width",""+this.config.width+"px").style("padding-top","20px").style("padding-bottom","20px").append("strong").text(this.config.heading.text)},psd3.Pie.prototype.getDepth=function(t){for(var e=t[0],n=0;null!=e||void 0!==e;)e=e[this.config.inner][0],n++;return n},psd3.Pie.prototype.setDataSet=function(t,e,n,i){if(null===t||void 0===t)return i;if(e===n){for(var a=0;a<t.length;a++)i.push(t[a]);return i}for(var a=0;a<t.length;a++)i=this.setDataSet(t[a][this.config.inner],e,n+1,i);return i},psd3.Pie.prototype.drawPie=function(t){var e=this,n=[],i=d3.scale.category20(),a=e.config.containerId+"_tooltip",o=d3.select("#"+e.config.containerId).append("svg").attr("id",e.config.containerId+"_svg").attr("width",e.config.width).attr("height",e.config.height),r=d3.select("#"+e.config.containerId).append("div").attr("id",a).attr("class","psd3Hidden psd3Tooltip");r.append("p").append("span").attr("id","value").text("100%");var s=d3.layout.pie();s.value(function(t){return t[e.config.value]}),s.sort(null);for(var d=e.config.width/2,c=this.getDepth(t),p=0,l=c;l>=1;l--){var g=e.config.donutRadius+(d-e.config.donutRadius)/c*l,h=g-d/c;1==l&&(h=e.config.donutRadius);var u=d3.svg.arc().innerRadius(h).outerRadius(g),f="arc"+l,v=[],y=this.setDataSet(t,l,1,v),P=o.selectAll("g."+f).data(s(y)).enter().append("g").attr("class","arc "+f).attr("transform","translate("+d+","+d+")").on("dblclick",function(t){e.reDrawPie(t,y)});paths=P.append("path").attr("fill",function(t,e){return i(e+p)}),paths.on("mouseover",function(t){d3.select("#"+a).style("left",d3.event.clientX+"px").style("top",d3.event.clientY+"px").select("#value").html(e.config.tooltip(t.data,e.config.label)),d3.select("#"+a).classed("psd3Hidden",!1)}),paths.on("mouseout",function(){d3.select("#"+a).classed("psd3Hidden",!0)}),paths.each(function(t){t.arc=u,t.length=y.length,t.parentDs=y}),paths.transition().duration(e.config.transitionDuration).ease("linear").attrTween("d",function(t){var e={startAngle:0,endAngle:0},n=d3.interpolate(e,t);return function(e){return t.arc(n(e))}}),p+=y.length,n[l]=P}for(var l=1;c>=l;l++)n[l].append("text").transition().ease("linear").duration(e.config.transitionDuration).delay(e.config.transitionDuration).attr("transform",function(t){return"translate("+t.arc.centroid(t)+")"}).attr("text-anchor","middle").text(function(t){return e.config.label(t.data)}).attr("title",function(t){return t.data[e.config.value]})},psd3.Pie.prototype.reDrawPie=function(t,e){var n=[];d3.select("#"+this.config.containerId+"_svg").remove(),d3.select("#"+this.config.containerId+"_tooltip").remove(),1==t.length?n=this.zoomStack.pop():(n.push(t.data),this.zoomStack.push(e)),this.drawPie(n)};