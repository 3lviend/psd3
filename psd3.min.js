var psd3=psd3||{};psd3.Graph=function(t){var a=this;this.config=t,this.defaults={width:400,height:400,value:"value",inner:"inner",label:function(t){return t.data.value},tooltip:function(t){return void 0!==a.config.value?t[a.config.value]:t.value},transition:"linear",transitionDuration:1e3,donutRadius:0,gradient:!1,gradientDelta:1,colors:d3.scale.category20()};for(var i in this.defaults)this.defaults.hasOwnProperty(i)&&(t.hasOwnProperty(i)||(t[i]=this.defaults[i]))};
var psd3=psd3||{};psd3.Pie=function(t){psd3.Graph.call(this,t),this.zoomStack=[];var i="top";void 0!==this.config.heading&&void 0!==this.config.heading.pos&&(i=this.config.heading.pos),"top"==i&&this.setHeading(),this.drawPie(t.data),"bottom"==i&&this.setHeading()},psd3.Pie.prototype=Object.create(psd3.Graph.prototype),psd3.Pie.prototype.constructor=psd3.Pie,psd3.Pie.prototype.findMaxDepth=function(t){if(null===t||void 0===t||t.length<1)return 0;for(var i,e=0,n=0;n<t.length;n++){var o=this.findMaxDepth(t[n][this.config.inner]);o>e&&(e=o)}return i=1+e},psd3.Pie.prototype.setHeading=function(){void 0!==this.config.heading&&d3.select("#"+this.config.containerId).append("div").style("text-align","center").style("width",""+this.config.width+"px").style("padding-top","20px").style("padding-bottom","20px").append("strong").text(this.config.heading.text)},psd3.Pie.prototype.mouseover=function(t){d3.select("#"+_this.tooltipId).style("left",d3.event.clientX+"px").style("top",d3.event.clientY+"px").select("#value").html(_this.config.tooltip(t.data,_this.config.label)),d3.select("#"+_this.tooltipId).classed("psd3Hidden",!1)},psd3.Pie.prototype.mouseout=function(){d3.select("#"+_this.tooltipId).classed("psd3Hidden",!0)},psd3.Pie.prototype.drawPie=function(t){if(!(null===t||void 0===t||t.length<1)){_this=this,_this.arcIndex=0;var i=d3.select("#"+_this.config.containerId).append("svg").attr("id",_this.config.containerId+"_svg").attr("width",_this.config.width).attr("height",_this.config.height);_this.tooltipId=_this.config.containerId+"_tooltip";var e=d3.select("#"+_this.config.containerId).append("div").attr("id",_this.tooltipId).attr("class","psd3Hidden psd3Tooltip");e.append("p").append("span").attr("id","value").text("100%");var n;n=_this.config.width>_this.config.height?_this.config.width/2:_this.config.height/2;var o=_this.config.donutRadius,a=_this.findMaxDepth(t),s=o+(n-o)/a,r=s-o;_this.draw(i,n,t,t,t.length,o,s,r,0,7920/7/180,[0,0])}},psd3.Pie.prototype.customArcTween=function(t){var i={startAngle:t.startAngle,endAngle:t.startAngle},e=d3.interpolate(i,t);return function(i){return t.arc(e(i))}},psd3.Pie.prototype.textTransform=function(t){return"translate("+t.arc.centroid(t)+")"},psd3.Pie.prototype.textTitle=function(t){return t.data[_this.config.value]},psd3.Pie.prototype.draw=function(t,i,e,n,o,a,s,r,d,c,h){if(_this=this,!(null===e||void 0===e||e.length<1)){psd3.Pie.prototype.textText=function(t){return _this.config.label(t)};var p=d3.layout.pie();p.sort(null),p.value(function(t){return t[_this.config.value]}),p.startAngle(d).endAngle(c);for(var l=[],g=0;g<e.length;g++)l.push(e[g][_this.config.value]);var f=function(t){_this.reDrawPie(t,n)},u=d3.svg.arc().innerRadius(a).outerRadius(s);_this.arcIndex=_this.arcIndex+1;var _,v,x="arc"+_this.arcIndex,y=function(t){t.arc=u,t.length=e.length},I=t.selectAll("g."+x).data(p(e)).enter().append("g").attr("class","arc "+x).attr("transform","translate("+i+","+i+")").on("dblclick",f),P=t.append("svg:defs").append("svg:linearGradient").attr("id","gradient_"+_this.arcIndex).attr("x1","0%").attr("y1","0%").attr("x2","100%").attr("y2","100%").attr("spreadMethod","pad");if(_this.config.gradient){var m=Math.abs((_this.arcIndex%(20/_this.config.gradientDelta)-1)*_this.config.gradientDelta),w=Math.abs(m+_this.config.gradientDelta-1);console.log("arcindex = "+_this.arcIndex+"("+m+", "+w),_=_this.config.colors(m),v=_this.config.colors(w)}else _=v=_this.config.colors(this.arcIndex);console.log("color = "+_+", "+v),P.append("svg:stop").attr("offset","0%").attr("stop-color",_).attr("stop-opacity",1),P.append("svg:stop").attr("offset","100%").attr("stop-color",v).attr("stop-opacity",1);var D=I.append("path").attr("fill","url(#gradient_"+_this.arcIndex+")");D.on("mouseover",_this.mouseover),D.on("mouseout",_this.mouseout),D.each(y),D.transition().duration(_this.config.transitionDuration).delay(_this.config.transitionDuration*(_this.arcIndex-1)).ease(_this.config.transition).attrTween("d",_this.customArcTween);for(var A=(I.append("text").attr("x",function(){return h[0]}).attr("y",function(){return h[1]}).transition().ease(_this.config.transition).duration(_this.config.transitionDuration).delay(_this.config.transitionDuration*(_this.arcIndex-1)).attr("transform",function(t){var i=[];return i[0]=u.centroid(t)[0]-h[0],i[1]=u.centroid(t)[1]-h[1],"translate("+i+")"}).attr("text-anchor","middle").text(_this.textText).attr("title",_this.textTitle),0);A<e.length;A++)void 0!==e[A][_this.config.inner]&&_this.draw(t,i,e[A][_this.config.inner],n,o,a+r,s+r,r,D.data()[A].startAngle,D.data()[A].endAngle,u.centroid(D.data()[A]))}},psd3.Pie.prototype.reDrawPie=function(t,i){var e=[];d3.select("#"+_this.config.containerId+"_svg").remove(),1==t.length?e=_this.zoomStack.pop():(e.push(t.data),_this.zoomStack.push(i)),_this.drawPie(e)};