var psd3=psd3||{};psd3.Graph=function(t,i){this.data=t,this.config=i,this.defaults={width:400,height:400,value:"value",label:function(t){return t.label},tooltip:function(t){return void 0!==this.config.label?this.config.label(t):t.label},transitionDuration:1e3}};
var psd3=psd3||{};psd3.Pie=function(t,e){psd3.Graph.call(this,t,e),this.zoomStack=new Array,this.drawPie(t)},psd3.Pie.prototype=Object.create(psd3.Graph.prototype),psd3.Pie.prototype.constructor=psd3.Pie,psd3.Pie.prototype.getDepth=function(t){for(var e=t[0],n=0;null!=e||void 0!==e;)e=e.inner[0],n++;return n},psd3.Pie.prototype.setDataSet=function(t,e,n,i){if(null===t||void 0===t)return i;if(e===n){for(var a=0;a<t.length;a++)i.push(t[a]);return i}for(var a=0;a<t.length;a++)i=this.setDataSet(t[a].inner,e,n+1,i);return i},psd3.Pie.prototype.drawPie=function(t){var e,n,i,a,r,o,s=this;e=void 0!==config.width?config.width:this.defaults.width,n=void 0!==config.height?config.height:this.defaults.height,i=void 0!==config.transitionDuration?config.transitionDuration:this.defaults.transitionDuration,a=void 0!==config.value?config.value:this.defaults.value,r=void 0!==config.label?config.label:this.defaults.label,o=void 0!==config.tooltip?config.tooltip:this.defaults.tooltip;var d=[],c=d3.scale.category20(),l=s.config.containerId+"_tooltip",p=d3.select("#"+s.config.containerId).append("svg").attr("id",s.config.containerId+"_svg").attr("width",e).attr("height",n),u=d3.select("#"+s.config.containerId).append("div").attr("id",l).attr("class","psd3Hidden psd3Tooltip");u.append("p").append("span").attr("id","value").text("100%");var h=d3.layout.pie();h.value(function(t){return t[a]}),h.sort(null);for(var f=e/2,g=this.getDepth(t),v=0,y=g;y>=1;y--){var P=f/3*y,m=P-f/3,w=d3.svg.arc().innerRadius(m).outerRadius(P),D="arc"+y,x=[],I=this.setDataSet(t,y,1,x),S=p.selectAll("g."+D).data(h(I)).enter().append("g").attr("class","arc "+D).attr("transform","translate("+f+","+f+")").on("dblclick",function(t){s.reDrawPie(t,I)});paths=S.append("path").attr("fill",function(t,e){return c(e+v)}),paths.on("mouseover",function(t){d3.select("#"+l).style("left",d3.event.clientX+"px").style("top",d3.event.clientY+"px").select("#value").html(o(t.data,r)),d3.select("#"+l).classed("psd3Hidden",!1)}),paths.on("mouseout",function(){d3.select("#"+l).classed("psd3Hidden",!0)}),paths.each(function(t){t.arc=w,t.length=I.length,t.parentDs=I}),paths.transition().duration(i).ease("linear").attrTween("d",function(t){var e={startAngle:0,endAngle:0},n=d3.interpolate(e,t);return function(e){return t.arc(n(e))}}),v+=I.length,d[y]=S}for(var y=1;g>=y;y++)d[y].append("text").transition().ease("linear").duration(i).delay(i).attr("transform",function(t){return"translate("+t.arc.centroid(t)+")"}).attr("text-anchor","middle").text(function(t){return r(t.data)}).attr("title",function(t){return t.data[a]})},psd3.Pie.prototype.reDrawPie=function(t,e){var n=[];d3.select("#"+this.config.containerId+"_svg").remove(),d3.select("#"+this.config.containerId+"_tooltip").remove(),1==t.length?n=this.zoomStack.pop():(n.push(t.data),this.zoomStack.push(e)),this.drawPie(n)};